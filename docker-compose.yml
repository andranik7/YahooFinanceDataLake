services:
  # ============================================
  # AIRFLOW (Orchestration)
  # ============================================
  airflow:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:airflow@postgres:5432/airflow
      - AIRFLOW__CORE__FERNET_KEY=AEf0WxrZ2NVRYRVkkgkk4mONGv8rogecP239_JSmb0U=
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__WEBSERVER__SECRET_KEY=supersecretkey123
      - ELASTICSEARCH_HOST=elasticsearch
      - ELASTICSEARCH_PORT=9200
      - JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      - AIRFLOW__LOGGING__REMOTE_LOGGING=False
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
    depends_on:
      postgres:
        condition: service_healthy    # <-- attend que Postgres soit vraiment prÃªt
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - ./airflow/plugins:/opt/airflow/plugins
      - airflow_data:/opt/airflow/data
      - ./scripts:/opt/airflow/scripts
      - ./config:/opt/airflow/config
      - ./spark:/opt/airflow/spark
      - ./kibana:/opt/airflow/kibana
    ports:
      - "8080:8080"
    command: >
      bash -c "
      mkdir -p /opt/airflow/data/raw/stocks /opt/airflow/data/raw/news /opt/airflow/data/formatted/yahoo_finance/stocks /opt/airflow/data/formatted/yahoo_finance/news /opt/airflow/data/combined /opt/airflow/data/predictions &&
      chmod -R 777 /opt/airflow/data &&
      airflow db migrate &&
      airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true &&
      (sleep 30 && /opt/airflow/scripts/init_kibana.sh) &
      airflow webserver & airflow scheduler"
    networks:
      - bigdata-network

  # ============================================
  # POSTGRESQL (Airflow metadata)
  # ============================================
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=airflow
      - POSTGRES_PASSWORD=airflow
      - POSTGRES_DB=airflow
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - bigdata-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow"]
      interval: 5s
      retries: 5
      start_period: 5s

  # ============================================
  # SPARK (Processing)
  # ============================================
  spark-master:
    image: apache/spark:3.5.0
    user: "0"
    environment:
      - SPARK_MODE=master
    command: >
      bash -c "
      mkdir -p /opt/airflow/data/raw/stocks /opt/airflow/data/raw/news /opt/airflow/data/formatted/yahoo_finance/stocks /opt/airflow/data/formatted/yahoo_finance/news /opt/airflow/data/combined /opt/airflow/data/predictions &&
      chmod -R 777 /opt/airflow/data &&
      /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master"
    ports:
      - "7077:7077"
      - "8081:8080"
    volumes:
      - airflow_data:/opt/airflow/data
      - ./scripts:/opt/airflow/scripts
      - ./config:/opt/airflow/config
    networks:
      - bigdata-network

  spark-worker:
    image: apache/spark:3.5.0
    user: "0"
    environment:
      - SPARK_MASTER=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2g
      - SPARK_WORKER_DIR=/tmp/spark-worker
    command: >
      bash -c "
      mkdir -p /opt/airflow/data/raw/stocks /opt/airflow/data/raw/news /opt/airflow/data/formatted/yahoo_finance/stocks /opt/airflow/data/formatted/yahoo_finance/news /opt/airflow/data/combined /opt/airflow/data/predictions &&
      chmod -R 777 /opt/airflow/data &&
      /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 -d /tmp/spark-worker"
    depends_on:
      - spark-master
    volumes:
      - airflow_data:/opt/airflow/data
      - ./scripts:/opt/airflow/scripts
      - ./config:/opt/airflow/config
    networks:
      - bigdata-network

  # ============================================
  # ELASTICSEARCH (Indexing)
  # ============================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - bigdata-network

  # ============================================
  # KIBANA (Dashboard)
  # ============================================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - bigdata-network

networks:
  bigdata-network:
    driver: bridge

volumes:
  postgres-data:
  elasticsearch-data:
  airflow_data:
